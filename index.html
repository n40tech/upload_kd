<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WP Content Collector</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* CSS to hide forms initially */
        .hidden-form {
            display: none;
            opacity: 0;
        }
        .form-section {
            transition: opacity 0.3s ease-in-out;
        }
        
        .instructions {
            background-color: #fefce8; /* Lighter yellow */
            border: 1px solid #fde047; /* Yellow border */
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        .instructions h3 {
            font-weight: 600;
            color: #854d0e; /* Darker yellow/brown */
            margin-bottom: 8px;
        }
        .instructions ol {
            list-style-type: decimal;
            list-style-position: inside;
            padding-left: 4px;
        }
        .instructions code {
            background-color: #f3f4f6;
            color: #be123c;
            font-size: 0.875rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        /* Styles for loading and messages */
        .message-box {
            display: none;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .message-box h4 {
            font-weight: 700;
            margin-bottom: 8px;
        }
        .message-box.success {
            background-color: #e6f7ec;
            border: 1px solid #b7ebc9;
            color: #0f5127;
        }
        .message-box.error {
            background-color: #fdeaea;
            border: 1px solid #f9c6c6;
            color: #5d1111;
        }
        .message-box a {
            color: #0056b3;
            font-weight: 600;
            text-decoration: underline;
        }
        
        /* Style for disabled buttons */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Styles for "Clear" button on image inputs */
        .clear-image-btn {
            background-color: #ef4444; /* red-500 */
            color: white;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* medium */
            padding: 0 0.75rem; /* px-3 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s;
            height: 42px; /* Match input height */
        }
        .clear-image-btn:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Custom styles for dynamic file input */
        .custom-file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
            flex: 1 1 0%;
            min-width: 150px;
            border: 2px dashed #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
        }
        .custom-file-input.dragover {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        .custom-file-input input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .custom-file-input-label {
            /* Mimic Tailwind input */
            display: block;
            padding: 0.5rem; /* p-2 */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* gray-700 */
            cursor: pointer;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: #ffffff;
            height: 42px; /* Match text input height */
            line-height: 2; /* Center text vertically */
        }
        .custom-file-input input[type="file"]:hover + .custom-file-input-label {
            background-color: #f9fafb; /* gray-50 */
        }
        .custom-file-input.dragover .custom-file-input-label {
             background-color: transparent;
        }

        /* Styles for static drag-drop zones */
        .drop-zone-container {
            border: 2px dashed #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
            padding: 0.5rem;
            flex: 1;
            /* NEW: Add min-height for better drop target */
            min-height: 58px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drop-zone-container.dragover {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        .drop-zone-container input[type="file"] {
            border: none;
            padding: 0;
            width: 100%;
            /* Make file selector button match */
            file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200;
        }
        .drop-zone-container.dragover input[type="file"] {
            background-color: transparent;
        }
        
        /* NEW: Styles for gallery preview items */
        .gallery-preview-item {
            position: relative;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden;
            background-color: #f9fafb; /* gray-50 */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .gallery-preview-item img {
            width: 100%;
            height: 100px; /* fixed height */
            object-fit: cover; /* crop to fit */
        }
        .gallery-preview-item .caption-input {
            width: 100%;
            border: none;
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #374151;
        }
        .gallery-preview-item .caption-input:focus {
            outline: 2px solid #3b82f6; /* blue-500 */
            outline-offset: -1px;
        }
        .gallery-preview-item .remove-image-btn {
            position: absolute;
            top: 0.25rem; /* top-1 */
            right: 0.25rem; /* right-1 */
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 9999px; /* rounded-full */
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            font-size: 0.875rem; /* text-sm */
            font-weight: bold;
            line-height: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .gallery-preview-item .remove-image-btn:hover {
            background-color: rgba(239, 68, 68, 0.9); /* red-500 */
        }
        
        /* NEW: Style for featured image preview */
        #portfolio-featured-image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex">

    <!-- Sidebar -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800 text-white p-6 flex-shrink-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
        <h2 class="text-2xl font-bold mb-6 text-white">Collector Menu</h2>
        <button id="mobile-menu-close" class="absolute top-4 right-4 md:hidden text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <nav>
            <a href="#" id="nav-uploader" class="text-base py-2 px-3 rounded-md block">Content Uploader</a>
            <a href="#" id="nav-updates" class="text-base py-2 px-3 rounded-md block">Updates</a>
        </nav>
    </div>
    
    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-20 hidden md:hidden"></div>
    
    <!-- Main Content Area -->
    <div id="main-content-area" class="flex-1 h-screen overflow-y-auto">
    
        <!-- Mobile Header -->
        <div class="md:hidden sticky top-0 z-10 bg-white p-4 flex items-center shadow-sm">
            <button id="mobile-menu-button" class="text-gray-600 hover:text-gray-900">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-lg font-bold ml-4" id="mobile-page-title">Content Uploader</h1>
        </div>
        
        <!-- Page 1: Uploader -->
        <div id="uploader-page" class="p-4 md:p-6">
            <div class="container mx-auto max-w-2xl w-full">
                <div class="bg-white rounded-lg shadow-2xl p-8 relative">
                    
                    <h1 id="main-title" class="text-3xl font-bold text-center text-gray-800 mb-6">
                        WordPress Content Collector
                    </h1>
        
                    <!-- WP Details Form (Login Section) -->
                    <div id="login-section" class="space-y-4">
                        
                        <div id="instructions-box" class="instructions hidden">
                            <h3>How to Get Your Application Password</h3>
                            <ol class="space-y-1 text-sm text-gray-700">
                                <li>Log in to your WordPress admin (e.g., <code>yoursite.com/wp-admin</code>).</li>
                                <li>In the left-hand menu, go to <strong>Users</strong> > <strong>Profile</strong>.</li>
                                <li>Scroll down to the "<strong>Application Passwords</strong>" section.</li>
                                <li>In the "New Application Password Name" box, type a name (e.g., "Content Collector") and click "<strong>Add New Application Password</strong>".</li>
                                <li>WordPress will generate a password like <code>xxxx xxxx xxxx xxxx</code>.</li>
                                <li><strong>Copy this password</strong> (don't close the page until you do!) and paste it into the "Application Password" field below.</li>
                            </ol>
                        </div>
                        
                        <div id="manual-login-box" class="bg-gray-50 border border-gray-200 rounded-lg p-6 space-y-4">
                            <h2 class="text-xl font-semibold text-gray-700">Login to WordPress</h2>
                            <div class="hidden">
                                <label for="wp-url" class="block text-sm font-medium text-gray-600 mb-1">Your WordPress Site URL</label>
                                <input type="url" id="wp-url" placeholder="e.g., https://www.your-site.com" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="wp-user" class="block text-sm font-medium text-gray-600 mb-1">Your WordPress Username</label>
                                <input type="text" id="wp-user" placeholder="Your admin username" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="wp-pass" class="block text-sm font-medium text-gray-600 mb-1">Your Application Password</label>
                                <input type="password" id="wp-pass" placeholder="Paste the xxxx xxxx ... password here" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                            </div>
                            <button id="login-button" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 text-sm">
                                Login & Save Credentials
                            </button>
                            
                            <div class="flex items-center pt-2 hidden">
                                <div class="flex-grow border-t border-gray-300"></div>
                                <span class="flex-shrink mx-4 text-gray-500 text-sm">OR</span>
                                <div class="flex-grow border-t border-gray-300"></div>
                            </div>
                            
                            <div>
                            </div>
        
                            <!-- Login Status Feedback -->
                            <p id="login-status-msg" class="text-xs text-center" style="display: none;"></p>
                        </div>
                    
                        <!-- Centered key-upload div -->
                        <div class="pt-4 hidden">
                            <label for="key-upload" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 text-sm text-center cursor-pointer block">
                                Upload key.txt
                            </label>
                            <input type="file" id="key-upload" class="hidden" accept=".txt,text/plain">
                            <p id="key-upload-help-text" class="text-xs text-gray-500 text-center mt-2">
                                (A .txt file with URL on line 1, Username on line 2, and Password on line 3)
                            </p>
                            <p id="key-upload-msg" class="text-xs text-center mt-2" style="display: none;"></p>
                        </div>
                    </div>
                    
                    <!-- Main Application Section (Hidden by default) -->
                    <div id="main-app-section" class="hidden">
                    
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm text-green-600">
                                Logged in as: <span id="welcome-user" class="font-medium"></span>
                            </p>
                            <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600 hover:underline">Logout</button>
                        </div>
        
                        <!-- Step 1: Template Selection -->
                        <div class="mb-6">
                            <label for="template-select" class="block text-lg font-medium text-gray-700 mb-2">
                                Select a Template
                            </label>
                            <select id="template-select" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Please choose an option --</option>
                                <option value="media-link">Media (Link)</option>
                                <option value="media-video">Media (Video)</option>
                                <option value="work" id="option-work">Work</option>
                                <option value="exhibition" id="option-exhibition">Exhibitions</option>
                            </select>
                        </div>
        
                        <!-- Step 2: Dynamic Forms Container -->
                        <div id="forms-container">
                            
                            <!-- Media (Link) Form -->
                            <form id="media-link-form" class="form-section hidden-form space-y-4">
                                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">
                                    Media (Link) Details
                                </h2>
                                
                                <div>
                                    <label for="link-url" class="block text-sm font-medium text-gray-600 mb-1">Link URL <span class="text-red-500">*</span></label>
                                    <input type="url" id="link-url" placeholder="e.g., https://www.example.com" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label for="link-title" class="block text-sm font-medium text-gray-600 mb-1">Link Title <span class="text-red-500">*</span></label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="link-title" placeholder="e.g., Article about..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500" required>
                                    </div>
                                    <p id="link-title-status" class="text-xs mt-1"></p>
                                </div>
                                <div>
                                    <label for="link-callout" class="block text-sm font-medium text-gray-600 mb-1">Link Callout (Optional)</label>
                                    <select id="link-callout" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500">
                                        <option value="">-- Use Title as Link Text --</option>
                                        <option value="Read here">Read here</option>
                                        <option value="Watch here">Watch here</option>
                                        <option value="Listen here">Listen here</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="link-description" class="block text-sm font-medium text-gray-600 mb-1">Description</label>
                                    <textarea id="link-description" rows="3" placeholder="Short description of the link." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <label for="link-post-category" class="block text-sm font-medium text-gray-600 mb-1">Post Category</label>
                                    <select id="link-post-category" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500">
                                        <option value="">-- Select Category --</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                                <!-- NEW: Clarification Note -->
                                <div class="pt-2">
                                    <p class="text-xs text-gray-500 italic text-center">Note: Image galleries are only available for 'Work' and 'Exhibitions' templates.</p>
                                </div>
                                <button type="submit" data-default-text="Create 'Media (Link)' Post" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                                    Create "Media (Link)" Post
                                </button>
                            </form>
        
                            <!-- Media (Video) Form -->
                            <form id="media-video-form" class="form-section hidden-form space-y-4">
                                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">
                                    Media (Video) Details
                                </h2>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Video Source</label>
                                    <div class="flex gap-4" id="video-source-radios">
                                        <label class="flex items-center">
                                            <input type="radio" name="video-source" value="url" class="form-radio" checked>
                                            <span class="ml-2">URL</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="video-source" value="upload" class="form-radio">
                                            <span class="ml-2">Upload</span>
                                        </label>
                                    </div>
                                </div>
        
                                <div id="video-source-url-group">
                                    <label for="video-url" class="block text-sm font-medium text-gray-600 mb-1">Video URL (YouTube, Vimeo, etc.) <span id="video-url-required" class="text-red-500">*</span></label>
                                    <input type="url" id="video-url" placeholder="e.g., https://www.youtube.com/watch?v=..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                                </div>
        
                                <div id="video-source-upload-group" class="hidden space-y-2">
                                    <label for="video-file-upload" class="block text-sm font-medium text-gray-600 mb-1">Video File <span id="video-upload-required" class="text-red-500 hidden">*</span></label>
                                    <div class="flex gap-2 items-center">
                                        <div class="drop-zone-container">
                                            <!-- NEW: Removed accept="video/*" to allow all file types if needed, but video/* is safer. Re-adding. -->
                                            <input type="file" id="video-file-upload" accept="video/*">
                                        </div>
                                        <button type="button" id="video-file-upload-clear" class="clear-image-btn">Clear</button>
                                    </div>
                                    <div id="video-file-upload-preview" class="mt-2 text-sm text-gray-600 p-2 bg-gray-50 rounded-md border">
                                        <!-- Preview will be text, e.g., "Selected: my_video.mp4" -->
                                    </div>
                                </div>
        
                                <div>
                                    <label for="video-title" class="block text-sm font-medium text-gray-600 mb-1">Video Title <span class="text-red-500">*</span></label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="video-title" placeholder="e.g., Interview with..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500" required>
                                    </div>
                                    <p id="video-title-status" class="text-xs mt-1"></p>
                                </div>
                                <div>
                                    <label for="video-description" class="block text-sm font-medium text-gray-600 mb-1">Description</label>
                                    <textarea id="video-description" rows="3" placeholder="Short description of the video." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <label for="video-post-category" class="block text-sm font-medium text-gray-600 mb-1">Post Category</label>
                                    <select id="video-post-category" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-500">
                                        <option value="">-- Select Category --</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                                <!-- NEW: Clarification Note -->
                                <div class="pt-2">
                                    <p class="text-xs text-gray-500 italic text-center">Note: Image galleries are only available for 'Work' and 'Exhibitions' templates.</p>
                                </div>
                                <button type="submit" data-default-text="Create 'Media (Video)' Post" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                                    Create "Media (Video)" Post
                                </button>
                            </form>
                            
                            <form id="portfolio-form" class="form-section hidden-form space-y-4">
                                <h2 id="portfolio-form-title" class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">
                                    Work Details
                                </h2>
                                <div>
                                    <label for="portfolio-title" class="block text-sm font-medium text-gray-600 mb-1">Title <span class="text-red-500">*</span></label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="portfolio-title" placeholder="e.g., My New Sculpture" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500" required>
                                    </div>
                                    <p id="portfolio-title-status" class="text-xs mt-1"></p>
                                </div>
                                <div>
                                    <label for="portfolio-description" class="block text-sm font-medium text-gray-600 mb-1">Description</label>
                                    <textarea id="portfolio-description" rows="4" placeholder="Description of the work..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <label for="portfolio-tags" class="block text-sm font-medium text-gray-600 mb-1">Tags (comma-separated: year, mediums, bodies of work)</label>
                                    <input type="text" id="portfolio-tags" placeholder="e.g., 2024, sculpture, bronze, Project Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                                    <div id="portfolio-tags-status" class="text-xs mt-1 leading-snug"></div>
                                </div>
        
                                <!-- Exhibition-only fields -->
                                <div class="exhibition-only hidden">
                                    <label for="portfolio-gallery" class="block text-sm font-medium text-gray-600 mb-1">Gallery</label>
                                    <input type="text" id="portfolio-gallery" placeholder="e.g., Gallery Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                                </div>
                                <div class="grid grid-cols-2 gap-4 exhibition-only hidden">
                                    <div>
                                        <label for="portfolio-start-date" class="block text-sm font-medium text-gray-600 mb-1">Start Date</label>
                                        <input type="date" id="portfolio-start-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="portfolio-end-date" class="block text-sm font-medium text-gray-600 mb-1">End Date</label>
                                        <input type="date" id="portfolio-end-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="portfolio-featured-image" class="block text-sm font-medium text-gray-600 mb-1">Featured Image</label>
                                    <div class="flex gap-2 items-center">
                                        <div class="drop-zone-container">
                                            <input type="file" id="portfolio-featured-image" accept="image/*">
                                        </div>
                                        <button type="button" id="portfolio-featured-image-clear" class="clear-image-btn">Clear</button>
                                    </div>
                                    <!-- NEW: Preview div will be populated by JS -->
                                    <div id="portfolio-featured-image-preview" class="mt-2"></div>
                                </div>
                                
                                <!-- Hover Image field completely REMOVED -->
        
                                <div>
                                    <label for="portfolio-all-images" class="block text-sm font-medium text-gray-600 mb-1">Gallery (multi-select)</label>
                                    <div class="flex gap-2 items-center">
                                        <div class="drop-zone-container">
                                            <input type="file" id="portfolio-all-images" multiple accept="image/*">
                                        </div>
                                        <button type="button" id="portfolio-all-images-clear" class="clear-image-btn">Clear All</button>
                                    </div>
                                    <!-- NEW: Gallery helper text -->
                                    <p class="text-xs text-gray-500 mt-1">Add images (you can add more multiple times). Add captions as needed.</p>
                                    <!-- NEW: Gallery preview grid -->
                                    <div id="portfolio-all-images-preview" class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                                        <!-- Gallery items will be added here by JS -->
                                    </div>
                                </div>
        
                                <div class="border-t pt-4">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Optional: Files</h3>
                                    <div id="portfolio-files-container" class="space-y-2">
                                        <!-- Dynamic rows added here -->
                                    </div>
                                    <button type="button" id="portfolio-add-file-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ Add File</button>
                                </div>
                                <div class="border-t pt-4">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Optional: Links</h3>
                                    <div id="portfolio-links-container" class="space-y-2">
                                        <!-- Dynamic rows added here -->
                                    </div>
                                    <button type="button" id="portfolio-add-link-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ Add Link</button>
                                </div>
                                <button type="submit" id="portfolio-submit-button" data-default-text="Create 'Work' Post" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-300">
                                    Create "Work" Post
                                </button>
                            </form>
        
                        </div>
        
                        <!-- Step 3: Status / Output Section -->
                        <div id="output-section" class="mt-8 hidden-form">
        
                            <div id="loading-progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-2" style="display: none;">
                                <div id="loading-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="loading-progress-text" class="text-center text-sm text-gray-600 mb-4" style="display: none;"></p>
                            
                            <div id="message-success" class="message-box success">
                                <h4>Success! Post Created.</h4>
                                <p id="success-text"></p>
                                <p class="mt-2">
                                    <a id="edit-link" href="#" target="_blank">Edit Draft</a> | 
                                    <a id="view-link" href="#" target="_blank">Preview Post</a>
                                </p>
                            </div>
                            
                            <div id="message-error" class="message-box error">
                                <h4>Error</h4>
                                <p>There was a problem creating your post.</p>
                                <pre id="error-text" class="text-xs mt-2 p-2 bg-gray-700 text-red-300 rounded overflow-auto"></pre>
                            </div>
                            
                        </div>
                    </div> <!-- End Main App Section -->
                </div>
            </div>
        </div> <!-- End Uploader Page -->
    
        <!-- Page 2: Documentation -->
        <div id="documentation-page" class="hidden p-4 md:p-6">
            <div class="container mx-auto max-w-2xl w-full">
                <div class="bg-white rounded-lg shadow-2xl p-8 relative">
                    
                    <!-- NEW: Update 17/11/2025 -->
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3" id="update-17-11-2025">Updates: 17/11/2025</h1>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">How to Edit and Add to Your Posts</h2>
                    <p class="mb-4 text-gray-700">Thank you for the great feedback on editing! This guide explains how to add new content (images, links, videos, tags) to a post you have already published.
                    </p>
                    <p class="mb-4 text-gray-700">The <strong>Content Collector</strong> is perfect for <strong>creating</strong> your initial draft. For <strong>editing</strong> and adding to a post, the standard WordPress block editor is the safest and most powerful tool.
                    </p>
                    <p class="mb-4 text-gray-700">Hereâ€™s how to do the specific things you asked for:</p>

                    <h3 class="text-xl font-semibold text-gray-600 mt-6 mb-2">1. How to Add More Images to a Gallery</h3>
                    <!-- NEW: Clarification Note -->
                    <p class="mb-4 text-sm text-blue-700 bg-blue-50 p-3 rounded-lg"><strong>Quick Note:</strong> Image galleries are only for <strong>Work</strong> and <strong>Exhibitions</strong> posts. The "Media (Link)" and "Media (Video)" templates do not have galleries.</p>
                    <ol class="list-decimal list-inside space-y-3 text-gray-700">
                        <li>Go to your <strong>Portfolio</strong> and click <strong>"Edit"</strong> on the post you want to change.</li>
                        <li>Click directly on the main image gallery. A small toolbar will appear.</li>
                        <li>Click the <strong>"Edit Gallery"</strong> button (it might look like a pencil or three dots).</li>
                        <li>A new window will open. In the bottom-left, you will see a link: <strong>"Add to Gallery"</strong>. Click it.</li>
                        <li>You can now upload new images or select existing ones from your Media Library.</li>
                        <li>Once your new images are selected, click the <strong>"Add to Gallery"</strong> button, and then click <strong>"Update Gallery"</strong>.</li>
                        <li>Finally, click the main blue <strong>"Update"</strong> button for the whole post.</li>
                    </ol>

                    <h3 class="text-xl font-semibold text-gray-600 mt-6 mb-2">2. How to Add More Links or Videos</h3>
                    <p class="mb-4 text-gray-700">You can add new blocks for links or videos anywhere on the page.</p>
                    <ol class="list-decimal list-inside space-y-3 text-gray-700">
                        <li>In the editor, find a place where you want to add the new link/video and click to put your cursor there.</li>
                        <li>Click the blue <strong>`+`</strong> icon (or black `+` icon) to "Add block".</li>
                        <li>
                            <strong>For Links:</strong> Search for the <strong>"Paragraph"</strong> or <strong>"Button"</strong> block. Type your text, highlight it, and click the link icon in the toolbar to add the URL.
                        </li>
                        <li>
                            <strong>For Videos:</strong> Search for the <strong>"Video"</strong> or <strong>"Embed"</strong> block. You can paste your YouTube/Vimeo URL directly, or upload a video file.
                        </li>
                        <li>Click the main blue <strong>"Update"</strong> button for the post.</li>
                    </ol>

                    <h3 class="text-xl font-semibold text-gray-600 mt-6 mb-2">3. How to Add More Tags</h3>
                    <p class="mb-4 text-gray-700">This is the easiest one! You don't even have to touch the post content.</p>
                    <ol class="list-decimal list-inside space-y-3 text-gray-700">
                        <li>Open the post in the editor.</li>
                        <li>On the right-hand side, make sure the <strong>"Post"</strong> or <strong>"Portfolio Item"</strong> tab is selected.</li>
                        <li>Scroll down until you see the <strong>"Tags"</strong> (or <strong>"Portfolio Tags"</strong>) section.</li>
                        <li>Simply type your new tags into the box (e.g., "2025, new work, London") and press Enter.</li>
                        <li>Click the main blue <strong>"Update"</strong> button. The new tags will be added.</li>
                    </ol>

                    <!-- Previous Update -->
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3 mt-12" id="update-15-11-2025">Updates: 15/11/2025</h1>
                    
                    <p class="mb-4 text-gray-700">Because your website uses the `minimalio` theme, it has two main content types, which the uploader can now create:</p>
                    <ol class="list-decimal list-inside space-y-2 mb-6 bg-gray-50 p-4 rounded-md">
                        <li><strong>Posts:</strong> This is for your "Media (Link)" and "Media (Video)" items.</li>
                        <li><strong>Portfolio:</strong> This is for your "Work" and "Exhibitions" items.</li>
                    </ol>
                    <p class="mb-6 text-gray-700">This summary explains all the changes and, most importantly, <strong>where to find your new drafts</strong> for each type.</p>
    
                    <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4 mt-6">Part 1: Answers to Your Questions</h2>
    
                    <h3 class="text-xl font-semibold text-gray-600 mt-4 mb-2">How to edit a text that is already there?</h3>
                    <p class="mb-4 text-gray-700">This tool is designed only for <strong>creating new drafts</strong>, not for editing posts that are already on the website.</p>
                    <p class="mb-4 text-gray-700">To edit any post (whether it's a 'Post' or a 'Portfolio' item), you should use the <strong>"Edit Draft"</strong> link that appears right after you successfully create something. That link will always take you to the correct WordPress editor.</p>
    
                    <h3 class="text-xl font-semibold text-gray-600 mt-4 mb-2">I have made many many drafts: how to post them?</h3>
                    <p class="mb-4 text-gray-700">This is the most important part. Because you have two different types of content, they live in two different places in your WordPress dashboard.</p>
    
                    <h4 class="text-lg font-medium text-gray-600 mt-4 mb-2">How to Publish "Media (Link)" or "Media (Video)" drafts:</h4>
                    <p class="mb-2 text-gray-700">These items are saved as <strong>Posts</strong>.</p>
                    <ol class="list-decimal list-inside space-y-1 text-gray-700 mb-4">
                        <li>Log in to your WordPress admin.</li>
                        <li>In the left-hand menu, go to <strong>Posts</strong> &rarr; <strong>All Posts</strong>.</li>
                        <li>You will see your list of drafts. Find the one you want to publish (e.g., "My Video Interview") and click <strong>"Edit"</strong>.</li>
                        <li>This opens the standard post editor. In the top-right corner, click the blue <strong>"Publish"</strong> button.</li>
                    </ol>
    
                    <h4 class="text-lg font-medium text-gray-600 mt-4 mb-2">How to Publish "Work" or "Exhibitions" drafts:</h4>
                    <p class="mb-2 text-gray-700">These items are saved as <strong>Portfolio</strong> items.</p>
                    <ol class="list-decimal list-inside space-y-1 text-gray-700 mb-4">
                        <li>Log in to your WordPress admin.</li>
                        <li>In the left-hand menu, find the section called <strong>Portfolio</strong> (it may also be "Portfolio Items" or "Projects").</li>
                        <li>Click on it to see all your portfolio items.</li>
                        <li>You will see your list of drafts. Find the one you want to publish (e.g., "My New Sculpture") and click <strong>"Edit"</strong>.</li>
                        <li>This opens the portfolio editor. In the top-right corner, click the blue <strong>"Publish"</strong> button.</li>
                    </ol>
    
                    <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4 mt-8">Part 2: Summary of Recent Fixes &amp; New Features</h2>
                    <ul class="list-disc list-outside space-y-5 pl-6 text-gray-700">
                        <li>
                            <strong class="text-gray-800">Gallery (multi-select) - FIXED!</strong>
                            <ul class="list-circle list-outside pl-6 mt-2 space-y-1">
                                <li><strong>Problem:</strong> You would upload 4 images, then try to add a 5th, and it would delete the first 4.</li>
                                <li><strong>Solution:</strong> This is now fixed. You can add a batch of images, and then add more, and the new ones will be <strong>added to the list</strong> without replacing the old ones.</li>
                            </ul>
                        </li>
                        <li>
                            <strong class="text-gray-800">Gallery Auto-Fill - DONE!</strong>
                            <ul class="list-circle list-outside pl-6 mt-2 space-y-1">
                                <li><strong>Problem:</strong> After uploading, the gallery in the WordPress draft was empty,
                                    forcing you to re-add all the images.</li>
                                <li><strong>Solution:</strong> The uploader now <strong>automatically builds the
                                    <code class="text-sm bg-gray-100 p-1 rounded">minimalio</code> gallery</strong> for you. When you click "Edit Draft," the gallery
                                    will be fully populated with all the images you uploaded.</li>
                            </ul>
                        </li>
                        <li>
                            <strong class="text-gray-800">Photo Captions - DONE!</strong>
                            <ul class="list-circle list-outside pl-6 mt-2 space-y-1">
                                <li><strong>Problem:</strong> You wanted to add captions.</li>
                                <li><strong>Solution:</strong> When you add images to the "Gallery (multi-select)" box, you
                                    will now see a <strong>small text box under each image preview</strong>. Whatever you
                                    type in there will be saved as that photo's caption.</li>
                            </ul>
                        </li>
                        <li>
                            <strong class="text-gray-800">"Featured image" disappears - FIXED!</strong>
                            <ul class="list-circle list-outside pl-6 mt-2 space-y-1">
                                <li><strong>Problem:</strong> You would select a Featured Image, but it would disappear while
                                    you were filling out other fields.</li>
                                <li><strong>Solution:</strong> This was related to the gallery bug and is now fixed. The
                                    image you select will "stick" until you click "Clear" or submit the post.</li>
                            </ul>
                        </li>
                        <li>
                            <strong class="text-gray-800">New "Link Callout" Field - ADDED!</strong>
                            <ul class="list-circle list-outside pl-6 mt-2 space-y-1">
                                <li><strong>Problem:</strong> You wanted the link button on "Media (Link)" posts to say "Read
                                    here," "Watch here," or "Listen here."</li>
                                <li><strong>Solution:</strong> I've added a new dropdown menu to the "Media (Link)" form
                                    called <strong>"Link Callout (Optional)"</strong>. You can pick one of those
                                    options. If you leave it blank, the button will just use the post's title, like
                                    it did before.</li>
                            </ul>
                        </li>
                        <li>
                            <strong class="text-gray-800">"Tags" on the page - REMOVED!</strong>
                            <ul class="list-circle list-outside pl-6 mt-2 space-y-1">
                                <li><strong>Problem:</strong> You didn't want the tags (like "Work," "2024," or "sculpture")
                                    to be visible on the final post.</li>
                                <li><strong>Solution:</strong> Done. I've removed the code that was printing the tags onto
                                    the page. The tags are still saved in the background (which is good for
                                    organization!), but they will no longer appear on the public-facing post.
                                </li>
                            </ul>
                        </li>
                    </ul>
    
                </div>
            </div>
        </div> <!-- End Documentation Page -->
    
    </div> <!-- End Main Content Area -->
    
    <script>
        // === Global State Variables ===
        // NEW: These variables will hold the selected files, decoupled from the input elements.
        // This makes the selection persistent even if inputs are cleared or text is typed.
        let featuredImageFile = null;
        let videoFile = null;
        let galleryFiles = []; // This will be an array of objects: { id, file, caption }

        // === LocalStorage Helper Functions ===
        function setStorage(name, value) {
            try {
                localStorage.setItem(name, value || "");
            } catch (e) {
                console.error("LocalStorage write failed:", e);
            }
        }

        function getStorage(name) {
            try {
                return localStorage.getItem(name);
            } catch (e) {
                console.error("LocalStorage read failed:", e);
                return null;
            }
        }

        function eraseStorage(name) {
             try {
                localStorage.removeItem(name);
            } catch (e) {
                console.error("LocalStorage remove failed:", e);
            }
        }

        // === Get all the elements we need ===
        const loginSection = document.getElementById('login-section');
        const mainAppSection = document.getElementById('main-app-section');
        
        const templateSelect = document.getElementById('template-select');
        const formsContainer = document.getElementById('forms-container');
        const mediaLinkForm = document.getElementById('media-link-form');
        const mediaVideoForm = document.getElementById('media-video-form');
        const portfolioForm = document.getElementById('portfolio-form'); 
        
        const outputSection = document.getElementById('output-section');

        // WP Creds Elements
        const wpUrl = document.getElementById('wp-url');
        const wpUser = document.getElementById('wp-user');
        const wpPass = document.getElementById('wp-pass');
        const loginButton = document.getElementById('login-button');

        // Category Fetch Elements
        const loginStatusMsg = document.getElementById('login-status-msg');
        const linkCategorySelect = document.getElementById('link-post-category');
        const videoCategorySelect = document.getElementById('video-post-category');

        // Status Elements
        const messageSuccess = document.getElementById('message-success');
        const messageError = document.getElementById('message-error');
        const successText = document.getElementById('success-text');
        const errorText = document.getElementById('error-text');
        const editLink = document.getElementById('edit-link');
        const viewLink = document.getElementById('view-link');
        
        // Progress Bar Elements
        const loadingProgressContainer = document.getElementById('loading-progress-container');
        const loadingProgressBar = document.getElementById('loading-progress-bar');
        const loadingProgressText = document.getElementById('loading-progress-text');
        
        // App State Elements
        const welcomeUser = document.getElementById('welcome-user');
        const logoutButton = document.getElementById('logout-button');
        
        // Store all forms in an object for easy access
        const forms = {
            'media-link': mediaLinkForm,
            'media-video': mediaVideoForm,
            'work': portfolioForm,
            'exhibition': portfolioForm
        };
 
        const autoSaveKey = 'wpCollectorDraft';
        
        window.wpPortfolioTags = [];

        // === App State Functions ===
        function showLoginScreen(message = '', type = 'error') {
            loginSection.classList.remove('hidden');
            mainAppSection.classList.add('hidden');
            
            eraseStorage('wpCollectorUrl');
            eraseStorage('wpCollectorUser');
            eraseStorage('wpCollectorPass');

            wpUrl.value = 'https://katedaudy.com'; // SET IT HERE
            wpUser.value = '';
            wpPass.value = '';
            
            if (message) {
                loginStatusMsg.style.display = 'block';
                loginStatusMsg.className = type === 'error' ? 'text-xs text-red-600 text-center' : 'text-xs text-gray-500 text-center';
                loginStatusMsg.textContent = message;
            }
        }

        function showMainApp() {
            loginSection.classList.add('hidden');
            mainAppSection.classList.remove('hidden');
            welcomeUser.textContent = getStorage('wpCollectorUser');
            loadFormData();
        }

        // === Event Listeners ===

        loginButton.addEventListener('click', async (e) => {
            e.preventDefault();
            await fetchCategories();
        });
        
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            eraseStorage(autoSaveKey);
            // NEW: Clear file state on logout
            featuredImageFile = null;
            videoFile = null;
            galleryFiles = [];
            showLoginScreen('You have been logged out.', 'success');
        });

        window.addEventListener('load', async () => {
            wpUrl.value = 'https://katedaudy.com'; // SET THE VALUE
            const storedUser = getStorage('wpCollectorUser');
            const storedPass = getStorage('wpCollectorPass');
            
            if (storedUser) wpUser.value = storedUser;
            if (storedPass) wpPass.value = storedPass;

            if (storedUser && storedPass) {
                await fetchCategories();
            }
            
            // --- NEW: Sidebar Navigation ---
            const navUploader = document.getElementById('nav-uploader');
            const navUpdates = document.getElementById('nav-updates');
            const uploaderPage = document.getElementById('uploader-page');
            const documentationPage = document.getElementById('documentation-page');
            
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenuCloseButton = document.getElementById('mobile-menu-close');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const mobilePageTitle = document.getElementById('mobile-page-title');
        
            const navLinks = {
                'uploader': { link: navUploader, page: uploaderPage, title: 'Content Uploader' },
                'updates': { link: navUpdates, page: documentationPage, title: 'Updates' }
            };
            
            function closeMobileMenu() {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        
            function showPage(pageId) {
                Object.keys(navLinks).forEach(key => {
                    const item = navLinks[key];
                    if (key === pageId) {
                        item.page.classList.remove('hidden');
                        item.link.classList.add('bg-gray-700', 'text-white');
                        item.link.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                        mobilePageTitle.textContent = item.title;
                    } else {
                        item.page.classList.add('hidden');
                        item.link.classList.remove('bg-gray-700', 'text-white');
                        item.link.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                    }
                });
                
                // Close menu on navigation click on mobile
                if (window.innerWidth < 768) {
                    closeMobileMenu();
                }
            }
        
            navUploader.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('uploader');
            });
        
            navUpdates.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('updates');
            });
            
            mobileMenuButton.addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            });
            
            mobileMenuCloseButton.addEventListener('click', closeMobileMenu);
            sidebarOverlay.addEventListener('click', closeMobileMenu);
        
            // NEW: Anchor Link Handling
            function handleHashChange() {
                const hash = window.location.hash;
                if (!hash) return false; // No hash, do nothing

                const elementId = hash.substring(1);
                const element = document.getElementById(elementId);

                // Check if the element exists within the documentation page
                if (element && documentationPage.contains(element)) {
                    showPage('updates');
                    // Scroll to the element after a short delay
                    // (to ensure the page is visible)
                    setTimeout(() => {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                    return true; // Hash was handled
                }
                return false; // Hash was not for updates page
            }

            // Check for hash on initial load and listen for changes
            if (!handleHashChange()) {
                // If no hash was handled, show the uploader by default
                showPage('uploader');
            }
            window.addEventListener('hashchange', handleHashChange);
            
            // --- End of NEW: Sidebar Navigation ---
            
            // --- Setup Event Listeners (from original load event) ---
            // NEW: Setup stateful file handlers
            setupFeaturedImage();
            setupVideoFile();
            setupGallery();
            
            // Setup Add/Remove buttons for dynamic rows
            setupAddRemoveButtons('portfolio');

            // Setup Drag-and-Drop for static inputs
            document.querySelectorAll('.drop-zone-container').forEach(setupDragAndDrop);
            
            setupVideoFormToggle();

            // Add auto-https to static URL fields
            const urlFields = [
                document.getElementById('wp-url'),
                document.getElementById('link-url'),
                document.getElementById('video-url')
            ];
            
            urlFields.forEach(field => {
                if (field) {
                    field.addEventListener('blur', (e) => {
                        e.target.value = ensureHttps(e.target.value);
                    });
                }
            });
            
            // Setup Auto-Save listeners
            mainAppSection.querySelectorAll('input[type="text"], input[type="url"], input[type="date"], input[type="number"], textarea, select').forEach(el => {
                const eventType = (el.tagName === 'SELECT' || el.type === 'date') ? 'change' : 'input';
                el.addEventListener(eventType, saveFormData);
            });
            // Also save on radio change
            document.querySelectorAll('input[type="radio"]').forEach(el => {
                el.addEventListener('change', saveFormData);
            });
            
            // Setup Duplicate Check listeners (on blur)
            document.getElementById('link-title').addEventListener('blur', (e) => {
                checkDuplicateTitle(e.target.value, 'posts', 'link-title-status');
            });
            document.getElementById('video-title').addEventListener('blur', (e) => {
                checkDuplicateTitle(e.target.value, 'posts', 'video-title-status');
            });
             document.getElementById('portfolio-title').addEventListener('blur', (e) => {
                checkDuplicateTitle(e.g.target.value, 'portfolio', 'portfolio-title-status');
            });
            
            document.getElementById('portfolio-tags').addEventListener('input', (e) => {
                checkPortfolioTags(e.target.value);
            });
        });

        async function fetchCategories() {
            loginStatusMsg.style.display = 'block';
            loginStatusMsg.className = 'text-xs text-gray-500 text-center';
            loginStatusMsg.textContent = 'Logging in & fetching categories...';
            
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';

            let siteUrl, username, password, basicAuth, apiUrl;

            try {
                siteUrl = ensureHttps(wpUrl.value).replace(/\/+$/, '');
                username = wpUser.value;
                password = wpPass.value;

                if (!siteUrl || !username || !password) {
                    throw new Error('Please fill in URL, Username, and Password first.');
                }

                apiUrl = `${siteUrl}/wp-json/wp/v2/categories`;
                basicAuth = 'Basic ' + btoa(username + ':' + password);

                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': basicAuth }
                });

                const categories = await response.json();

                if (!response.ok) {
                    throw categories; // Throw WP error object
                }
                
                setStorage('wpCollectorUrl', siteUrl);
                setStorage('wpCollectorUser', username);
                setStorage('wpCollectorPass', password);
                
                populateCategoryDropdowns(categories);
                
                try {
                    const tagsApiUrl = `${siteUrl}/wp-json/wp/v2/portfolio-tags?per_page=100`;
                    const tagsResponse = await fetch(tagsApiUrl, { headers: { 'Authorization': basicAuth } });
                    const tags = await tagsResponse.json();
                    if (tagsResponse.ok) {
                        window.wpPortfolioTags = tags.map(tag => tag.name.toLowerCase());
                    } else {
                        console.warn('Could not fetch portfolio tags.');
                        window.wpPortfolioTags = [];
                    }
                } catch (tagError) {
                    console.warn('Portfolio tags fetch failed:', tagError);
                    window.wpPortfolioTags = [];
                }

                showMainApp();
                
                loginStatusMsg.textContent = 'Success! Logged in & categories fetched!';
                loginStatusMsg.className = 'text-xs text-green-600 text-center';
                
                setTimeout(() => {
                    loginStatusMsg.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('Error fetching categories:', error);
                let errorMessage = 'Could not fetch categories. Check credentials/URL.';
                
                if (error && error.message) { 
                    errorMessage = error.message;
                } else if (error instanceof Error) {
                    errorMessage = error.message;
                }
                
                showLoginScreen(errorMessage);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Login & Save Credentials';
            }
        }

        function populateCategoryDropdowns(categories) {
            const dropdowns = [linkCategorySelect, videoCategorySelect];
            
            dropdowns.forEach(dropdown => {
                while (dropdown.options.length > 1) {
                    dropdown.remove(1);
                }
                categories.forEach(category => {
                    if (category.slug === 'uncategorized') return; 
                    const option = document.createElement('option');
                    option.value = category.slug;
                    option.textContent = category.name;
                    dropdown.appendChild(option);
                });
            });
        }

        function ensureHttps(url) {
            const trimmedUrl = url.trim();
            if (trimmedUrl === '') return '';
            if (!/^(https?:\/\/)/i.test(trimmedUrl)) {
                return 'https://' + trimmedUrl;
            }
            return trimmedUrl;
        }

        // UPDATED: uploadMediaToWordPress now accepts a caption
        async function uploadMediaToWordPress(file, siteUrl, basicAuth, caption = null) {
            const formData = new FormData();
            formData.append('file', file);
            
            // NEW: Append caption if provided
            if (caption) {
                formData.append('caption', caption);
            }
            
            const response = await fetch(`${siteUrl}/wp-json/wp/v2/media`, {
                method: 'POST',
                headers: {
                    'Authorization': basicAuth
                },
                body: formData
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to upload media');
            }
            
            return await response.json();
        }
        
        // === NEW: Refactored File Preview and State Management ===

        // --- Featured Image ---
        function setupFeaturedImage() {
            const input = document.getElementById('portfolio-featured-image');
            const clearBtn = document.getElementById('portfolio-featured-image-clear');

            input.addEventListener('change', (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    featuredImageFile = e.target.files[0];
                    renderFeaturedImagePreview();
                }
            });
            
            clearBtn.addEventListener('click', () => {
                featuredImageFile = null;
                input.value = null; // Clear the file input
                renderFeaturedImagePreview();
            });
        }
        
        function renderFeaturedImagePreview() {
            const preview = document.getElementById('portfolio-featured-image-preview');
            preview.innerHTML = '';
            
            if (featuredImageFile) {
                if (featuredImageFile.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(featuredImageFile);
                } else {
                    preview.textContent = `Selected file: ${featuredImageFile.name}`;
                }
            }
        }

        // --- Video File ---
        function setupVideoFile() {
            const input = document.getElementById('video-file-upload');
            const clearBtn = document.getElementById('video-file-upload-clear');
            
            input.addEventListener('change', (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    videoFile = e.target.files[0];
                    renderVideoPreview();
                }
            });
            
            clearBtn.addEventListener('click', () => {
                videoFile = null;
                input.value = null; // Clear the file input
                renderVideoPreview();
            });
        }
        
        function renderVideoPreview() {
            const preview = document.getElementById('video-file-upload-preview');
            preview.innerHTML = '';
            if (videoFile) {
                preview.textContent = `Selected: ${videoFile.name}`;
            }
        }

        // --- Gallery Images (Multi-select) ---
        function setupGallery() {
            const input = document.getElementById('portfolio-all-images');
            const clearBtn = document.getElementById('portfolio-all-images-clear');
            
            input.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files) return;
                
                for (const file of Array.from(files)) {
                    // Add to our state array
                    galleryFiles.push({
                        id: Date.now() + Math.random(), // simple unique ID
                        file: file,
                        caption: ''
                    });
                }
                
                renderGalleryPreview();
                
                // IMPORTANT: Clear the input value so the user can add more files
                e.target.value = null;
            });
            
            clearBtn.addEventListener('click', () => {
                galleryFiles = []; // Clear the state array
                renderGalleryPreview();
            });
        }
        
        function renderGalleryPreview() {
            const previewContainer = document.getElementById('portfolio-all-images-preview');
            previewContainer.innerHTML = ''; // Clear existing previews
            
            galleryFiles.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'gallery-preview-item';
                
                let imgPreview = '';
                if (item.file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        // We create an img element and set its src *after* it's added
                        // to the DOM, so we find it by a data-id
                        const imgEl = itemDiv.querySelector(`[data-img-id="${item.id}"]`);
                        if(imgEl) imgEl.src = event.target.result;
                    };
                    reader.readAsDataURL(item.file);
                    imgPreview = `<img src="" alt="Preview" data-img-id="${item.id}">`;
                } else {
                    // Fallback for non-image files
                    imgPreview = `<div class="h-[100px] flex items-center justify-center p-2 text-xs text-center text-gray-600">${item.file.name}</div>`;
                }
                
                itemDiv.innerHTML = `
                    <button class="remove-image-btn" data-id="${item.id}">&times;</button>
                    ${imgPreview}
                    <input type="text" class="caption-input" placeholder="Add caption..." value="${escapeHTML(item.caption)}">
                `;
                
                previewContainer.appendChild(itemDiv);
                
                // Add event listeners for this new item
                itemDiv.querySelector('.remove-image-btn').addEventListener('click', () => {
                    const index = galleryFiles.findIndex(g => g.id === item.id);
                    if (index > -1) {
                        galleryFiles.splice(index, 1);
                        renderGalleryPreview(); // Re-render
                    }
                });
                
                itemDiv.querySelector('.caption-input').addEventListener('input', (e) => {
                    const index = galleryFiles.findIndex(g => g.id === item.id);
                    if (index > -1) {
                        galleryFiles[index].caption = e.target.value;
                    }
                });
            });
        }
        
        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/"/g, '&quot;');
        }
        
        // --- End of New File Preview Logic ---
        
        function setupDragAndDrop(zoneElement) {
            const input = zoneElement.querySelector('input[type="file"]');
            if (!zoneElement || !input) return;

            zoneElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                zoneElement.classList.add('dragover');
            });

            zoneElement.addEventListener('dragleave', (e) => {
                e.preventDefault();
                zoneElement.classList.remove('dragover');
            });

            zoneElement.addEventListener('drop', (e) => {
                e.preventDefault();
                zoneElement.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }

        function setupDynamicDragAndDrop(dropZone, fileInput) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }

        function setupAddRemoveButtons(prefix) {
            const addFileBtn = document.getElementById(`${prefix}-add-file-btn`);
            const addLinkBtn = document.getElementById(`${prefix}-add-link-btn`);
            const filesContainer = document.getElementById(`${prefix}-files-container`);
            const linksContainer = document.getElementById(`${prefix}-links-container`);
            
            if (addFileBtn && filesContainer) {
                addFileBtn.addEventListener('click', () => {
                    const row = document.createElement('div');
                    row.className = 'flex flex-wrap md:flex-nowrap gap-2 items-center';
                    row.innerHTML = `
                        <input type="text" placeholder="File title" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 min-w-[100px]">
                        <div class="custom-file-input">
                            <input type="file" class="file-input-dynamic">
                            <span class="custom-file-input-label">Choose file... (or drag here)</span>
                        </div>
                        <button type="button" class="remove-file-btn bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600">Remove</button>
                    `;
                    filesContainer.appendChild(row);

                    const fileInput = row.querySelector('.file-input-dynamic');
                    const fileLabel = row.querySelector('.custom-file-input-label');
                    fileInput.addEventListener('change', () => {
                        fileLabel.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'Choose file... (or drag here)';
                    });

                    const dropZone = row.querySelector('.custom-file-input');
                    setupDynamicDragAndDrop(dropZone, fileInput);

                    row.querySelector('.remove-file-btn').addEventListener('click', () => row.remove());
                });
            }
            
            if (addLinkBtn && linksContainer) {
                addLinkBtn.addEventListener('click', () => {
                    const row = document.createElement('div');
                    row.className = 'flex flex-wrap md:flex-nowrap gap-2';
                    row.innerHTML = `
                        <input type="text" placeholder="Link title" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 min-w-[100px]">
                        <input type="url" placeholder="Link URL" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 min-w-[150px]">
                        <button type="button" class="remove-link-btn bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600">Remove</button>
                    `;
                    linksContainer.appendChild(row);
                    row.querySelector('.remove-link-btn').addEventListener('click', () => row.remove());

                    const newUrlInput = row.querySelector('input[type="url"]');
                    if (newUrlInput) {
                        newUrlInput.addEventListener('blur', (e) => {
                            e.target.value = ensureHttps(e.target.value);
                        });
                    }
                    
                    row.querySelectorAll('input').forEach(input => {
                        input.addEventListener('input', saveFormData);
                    });
                });
                
                linksContainer.querySelectorAll('input[type="url"]').forEach(urlInput => {
                    urlInput.addEventListener('blur', (e) => {
                        e.target.value = ensureHttps(e.target.value);
                    });
                });
            }
        }

        // === Auto-Save Functions ===
        function saveFormData() {
            if (mainAppSection.classList.contains('hidden')) return;
 
            const formData = {
                template: templateSelect.value,
                // Media (Link)
                linkUrl: document.getElementById('link-url').value,
                linkTitle: document.getElementById('link-title').value,
                linkCallout: document.getElementById('link-callout').value,
                linkDesc: document.getElementById('link-description').value,
                linkCat: document.getElementById('link-post-category').value,
                // Media (Video)
                videoUrl: document.getElementById('video-url').value,
                videoTitle: document.getElementById('video-title').value,
                videoDesc: document.getElementById('video-description').value,
                videoCat: document.getElementById('video-post-category').value,
                videoSource: document.querySelector('input[name="video-source"]:checked').value,
                // Merged portfolio fields
                portfolioTitle: document.getElementById('portfolio-title').value,
                portfolioDesc: document.getElementById('portfolio-description').value,
                portfolioTags: document.getElementById('portfolio-tags').value,
                portfolioGallery: document.getElementById('portfolio-gallery').value,
                portfolioStart: document.getElementById('portfolio-start-date').value,
                portfolioEnd: document.getElementById('portfolio-end-date').value,
                portfolioLinks: [], 
                portfolioFiles: [],
                // NEW: Save file *names* as placeholders. We can't save the files themselves.
                featuredImageName: featuredImageFile ? featuredImageFile.name : null,
                videoFileName: videoFile ? videoFile.name : null,
                galleryFileNames: galleryFiles.map(item => ({ name: item.file.name, caption: item.caption }))
            };

            document.querySelectorAll('#portfolio-files-container .flex').forEach(row => {
                const titleInput = row.querySelector('input[type="text"]');
                if (titleInput) {
                    formData.portfolioFiles.push({ title: titleInput.value });
                }
            });
            document.querySelectorAll('#portfolio-links-container .flex').forEach(row => {
                const titleInput = row.querySelector('input[type="text"]');
                const urlInput = row.querySelector('input[type="url"]');
                if (titleInput && urlInput) {
                    formData.portfolioLinks.push({ title: titleInput.value, url: urlInput.value });
                }
            });

            localStorage.setItem(autoSaveKey, JSON.stringify(formData));
        }

        function loadFormData() {
            const savedData = localStorage.getItem(autoSaveKey);
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);
                
                document.getElementById('link-url').value = data.linkUrl || '';
                document.getElementById('link-title').value = data.linkTitle || '';
                document.getElementById('link-callout').value = data.linkCallout || '';
                document.getElementById('link-description').value = data.linkDesc || '';
                document.getElementById('link-post-category').value = data.linkCat || '';
                
                document.getElementById('video-url').value = data.videoUrl || '';
                document.getElementById('video-title').value = data.videoTitle || '';
                document.getElementById('video-description').value = data.videoDesc || '';
                document.getElementById('video-post-category').value = data.videoCat || '';
                if(data.videoSource) {
                    const radio = document.querySelector(`input[name="video-source"][value="${data.videoSource}"]`);
                    if(radio) radio.click(); 
                }

                document.getElementById('portfolio-title').value = data.portfolioTitle || '';
                document.getElementById('portfolio-description').value = data.portfolioDesc || '';
                document.getElementById('portfolio-tags').value = data.portfolioTags || '';
                document.getElementById('portfolio-gallery').value = data.portfolioGallery || '';
                document.getElementById('portfolio-start-date').value = data.portfolioStart || '';
                document.getElementById('portfolio-end-date').value = data.portfolioEnd || '';

                const portfolioAddFileBtn = document.getElementById('portfolio-add-file-btn');
                if (data.portfolioFiles && portfolioAddFileBtn) {
                    data.portfolioFiles.forEach(file => {
                        if (file && file.title) {
                            portfolioAddFileBtn.click();
                            const newRow = document.querySelector('#portfolio-files-container .flex:last-child');
                            if (newRow) {
                                newRow.querySelector('input[type="text"]').value = file.title || '';
                            }
                        }
                    });
                }
                const portfolioAddLinkBtn = document.getElementById('portfolio-add-link-btn');
                if (data.portfolioLinks && portfolioAddLinkBtn) {
                    data.portfolioLinks.forEach(link => {
                        if (link && (link.title || link.url)) {
                            portfolioAddLinkBtn.click(); 
                            const newRow = document.querySelector('#portfolio-links-container .flex:last-child');
                            if (newRow) {
                                newRow.querySelector('input[type="text"]').value = link.title || '';
                                newRow.querySelector('input[type="url"]').value = link.url || '';
                            }
                        }
                    });
                }
                
                if (data.portfolioTags) {
                    checkPortfolioTags(data.portfolioTags);
                }
                
                // NEW: Restore file placeholders. We can't restore the files, but we can show
                // that something *was* selected, so it doesn't look like it vanished.
                if (data.featuredImageName) {
                    const preview = document.getElementById('portfolio-featured-image-preview');
                    preview.innerHTML = `<p class="text-sm text-gray-500 p-2 bg-gray-50 rounded-md border">Selected: <strong>${escapeHTML(data.featuredImageName)}</strong><br>(File must be re-selected to submit)</p>`;
                }
                if (data.videoFileName) {
                    const preview = document.getElementById('video-file-upload-preview');
                    preview.innerHTML = `<p class="text-sm text-gray-500 p-2 bg-gray-50 rounded-md border">Selected: <strong>${escapeHTML(data.videoFileName)}</strong><br>(File must be re-selected to submit)</p>`;
                }
                if (data.galleryFileNames && data.galleryFileNames.length > 0) {
                    const preview = document.getElementById('portfolio-all-images-preview');
                    preview.innerHTML = `<p class="text-sm text-gray-500 p-2 bg-gray-50 rounded-md border col-span-full">You had <strong>${data.galleryFileNames.length}</strong> gallery images selected. Please re-select them to submit.</p>`;
                    // We don't restore galleryFiles array because the File objects are gone.
                }

                if (data.template) {
                    templateSelect.value = data.template;
                    templateSelect.dispatchEvent(new Event('change'));
                }

            } catch (e) {
                console.error('Failed to load auto-saved data:', e);
                localStorage.removeItem(autoSaveKey);
            }
        }

        // === Duplicate Title Check ===
        async function checkDuplicateTitle(title, postType, statusElementId) {
            const statusEl = document.getElementById(statusElementId);
            if (!title) {
                statusEl.textContent = '';
                return;
            }
            
            statusEl.textContent = 'Checking...';
            statusEl.className = 'text-xs mt-1 text-gray-500';

            try {
                const siteUrl = getStorage('wpCollectorUrl').replace(/\/+$/, '');
                const basicAuth = 'Basic ' + btoa(getStorage('wpCollectorUser') + ':' + getStorage('wpCollectorPass'));
                
                const apiUrl = `${siteUrl}/wp-json/wp/v2/${postType}?search=${encodeURIComponent(title)}&status=publish,draft,pending,future,private`;
                
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': basicAuth }
                });

                if (!response.ok) throw new Error('API request failed');
                
                const results = await response.json();
                
                const exactMatch = results.find(post => 
                    post.title && post.title.rendered && 
                    post.title.rendered.toLowerCase() === title.toLowerCase()
                );
                
                if (exactMatch) {
                    statusEl.textContent = 'Warning: A post with this exact title already exists.';
                    statusEl.className = 'text-xs mt-1 text-yellow-600';
                } else if (results.length > 0) {
                    statusEl.textContent = 'Note: Similar titles exist, but no exact match found.';
                    statusEl.className = 'text-xs mt-1 text-blue-600';
                } else {
                    statusEl.textContent = 'Title appears to be unique.';
                    statusEl.className = 'text-xs mt-1 text-green-600';
                }
            } catch (error) {
                console.error('Duplicate check failed:', error);
                statusEl.textContent = 'Could not check title.';
                statusEl.className = 'text-xs mt-1 text-red-600';
            }
        }
        
        function checkPortfolioTags(tagsInput) {
            const statusEl = document.getElementById('portfolio-tags-status');
            if (!window.wpPortfolioTags || !statusEl) return;

            const existingTags = window.wpPortfolioTags;
            const currentTags = tagsInput.split(',')
                .map(t => t.trim().toLowerCase())
                .filter(t => t);

            if (currentTags.length === 0) {
                statusEl.innerHTML = '';
                return;
            }

            const newTags = [];
            const matchedTags = [];

            currentTags.forEach(tag => {
                const found = existingTags.find(existing => existing === tag);
                if (found) {
                    matchedTags.push(tag);
                } else {
                    newTags.push(tag);
                }
            });

            let html = '';
            if (matchedTags.length > 0) {
                html += `<div><span class="font-medium text-green-700">Existing:</span> ${matchedTags.join(', ')}</div>`;
            }
            if (newTags.length > 0) {
                html += `<div><span class="font-medium text-blue-700">New:</span> ${newTags.join(', ')}</div>`;
            }
            statusEl.innerHTML = html;
        }

        
        function setupVideoFormToggle() {
            const radios = document.querySelectorAll('input[name="video-source"]');
            const urlGroup = document.getElementById('video-source-url-group');
            const uploadGroup = document.getElementById('video-source-upload-group');
            const urlRequired = document.getElementById('video-url-required');
            const uploadRequired = document.getElementById('video-upload-required');

            function toggle(value) {
                if (value === 'url') {
                    urlGroup.classList.remove('hidden');
                    uploadGroup.classList.add('hidden');
                    urlRequired.classList.remove('hidden');
                    uploadRequired.classList.add('hidden');
                } else {
                    urlGroup.classList.add('hidden');
                    uploadGroup.classList.remove('hidden');
                    urlRequired.classList.add('hidden');
                    uploadRequired.classList.remove('hidden');
                }
            }

            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggle(e.target.value);
                });
            });
            toggle(document.querySelector('input[name="video-source"]:checked').value);
        }

        // === Initialize Event Listeners on Page Load ===
        // DELETED window.addEventListener('load', () => { ... })

        // --- Event Listener for Template Dropdown ---
        templateSelect.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            
            Object.values(forms).forEach(form => {
                form.classList.add('hidden-form');
                form.style.opacity = 0;
            });
            
            hideOutput();

            if (forms[selectedValue]) {
                const formToShow = forms[selectedValue];
                
                if (selectedValue === 'work' || selectedValue === 'exhibition') {
                    const submitButton = document.getElementById('portfolio-submit-button');
                    const formTitle = document.getElementById('portfolio-form-title');
                    const exhibitionFields = document.querySelectorAll('.exhibition-only');
                    
                    const titleText = selectedValue === 'work' ? 'Work' : 'Exhibitions';
                    
                    formTitle.textContent = `${titleText} Details`;
                    submitButton.textContent = `Create '${titleText}' Post`;
                    submitButton.dataset.defaultText = `Create '${titleText}' Post`;
                    
                    if (selectedValue === 'exhibition') {
                        submitButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                        submitButton.classList.add('bg-teal-600', 'hover:bg-teal-700');
                        exhibitionFields.forEach(field => field.classList.remove('hidden'));
                    } else {
                        submitButton.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                        submitButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
                        exhibitionFields.forEach(field => field.classList.add('hidden'));
                    }
                }
                
                formToShow.classList.remove('hidden-form');
                setTimeout(() => {
                    formToShow.style.opacity = 1;
                }, 10);
            }
        });
        
        function hideOutput() {
            outputSection.classList.add('hidden-form');
            messageSuccess.style.display = 'none';
            messageError.style.display = 'none';
            loadingProgressContainer.style.display = 'none';
            loadingProgressText.style.display = 'none';
        }

        function showError(message) {
            loadingProgressContainer.style.display = 'none';
            loadingProgressText.style.display = 'none';
            messageError.style.display = 'block';
            messageSuccess.style.display = 'none';
            errorText.textContent = message;
        }

        function updateProgress(uploaded, total, message) {
            loadingProgressText.textContent = message;
            if (total === 0) {
                loadingProgressBar.style.width = '100%';
                return;
            }
            const percent = Math.round((uploaded / total) * 100);
            loadingProgressBar.style.width = percent + '%';
        }

        // --- Function to handle form submission and POST to WordPress ---
        async function handleFormSubmit(event, templateType) {
            event.preventDefault(); 
            
            outputSection.classList.remove('hidden-form');
            loadingProgressContainer.style.display = 'block';
            loadingProgressText.style.display = 'block';
            loadingProgressBar.style.width = '0%';
            messageSuccess.style.display = 'none';
            messageError.style.display = 'none';

            let data = {};
            const submitButton = event.target.querySelector('button[type="submit"]');
            
            const siteUrlStored = getStorage('wpCollectorUrl');
            const username = getStorage('wpCollectorUser');
            const password = getStorage('wpCollectorPass');
            
            if (!siteUrlStored || !username || !password) {
                showError("Your login session has expired. Please log out and log back in.");
                if(submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = submitButton.dataset.defaultText || 'Submit';
                }
                return; 
            }
            
            const siteUrl = siteUrlStored.replace(/\/+$/, '');
            const basicAuth = 'Basic ' + btoa(username + ':' + password);
            
            let totalFiles = 0;
            let filesUploaded = 0;

            if(submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Creating...';
            }
            
            try {
                // === Client-side Validation & Data Collection ===
                if (templateType === 'media-link') {
                    updateProgress(0, 0, 'Creating post...');
                    const url = document.getElementById('link-url').value;
                    const title = document.getElementById('link-title').value;
                    if (!url || !title) throw new Error('Please fill in both the Link URL and Link Title.');
                    data = {
                        template: 'media-link',
                        url: ensureHttps(url),
                        title: title,
                        linkCallout: document.getElementById('link-callout').value,
                        description: document.getElementById('link-description').value,
                        postCategory: document.getElementById('link-post-category').value,
                    };
                } else if (templateType === 'media-video') {
                    
                    const title = document.getElementById('video-title').value;
                    if (!title) throw new Error('Please fill in the Video Title.');
                    
                    const videoSource = document.querySelector('input[name="video-source"]:checked').value;
                    
                    data = {
                        template: 'media-video',
                        title: title,
                        description: document.getElementById('video-description').value,
                        postCategory: document.getElementById('video-post-category').value,
                        videoType: videoSource
                    };

                    if (videoSource === 'url') {
                        const url = document.getElementById('video-url').value;
                        if (!url) throw new Error('Please fill in the Video URL.');
                        data.url = ensureHttps(url);
                        updateProgress(0, 0, 'Creating post...');
                    } else {
                        // NEW: Check state variable
                        if (!videoFile) {
                            throw new Error('Please select a video file to upload.');
                        }
                        
                        totalFiles = 1; 
                        updateProgress(0, totalFiles, 'Uploading video...');
                        
                        // NEW: Upload from state variable
                        const uploaded = await uploadMediaToWordPress(videoFile, siteUrl, basicAuth);
                        data.videoId = uploaded.id;
                        filesUploaded = 1;
                        updateProgress(1, 1, 'Video uploaded. Creating post...');
                    }
                    
                } else if (templateType === 'work' || templateType === 'exhibition') {
                    
                    const title = document.getElementById('portfolio-title').value;
                    if (!title) throw new Error(`Please fill in the ${templateType === 'work' ? 'Work' : 'Exhibitions'} Title.`);
                    
                    const description = document.getElementById('portfolio-description').value;
                    const tagsInput = document.getElementById('portfolio-tags').value;
                    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                    
                    const filesContainer = document.getElementById('portfolio-files-container');
                    
                    // NEW: Calculate total files from state variables
                    if (featuredImageFile) totalFiles++;
                    totalFiles += galleryFiles.length;
                    
                    if (filesContainer) {
                        filesContainer.querySelectorAll('.flex').forEach(row => {
                            const fileInput = row.querySelector('.file-input-dynamic');
                            if (fileInput && fileInput.files.length > 0) {
                                totalFiles++;
                            }
                        });
                    }
                    updateProgress(0, totalFiles, 'Starting upload...');
                    
                    // NEW: Upload from galleryFiles array
                    const allImagesIds = [];
                    if (galleryFiles.length > 0) {
                        for (const item of galleryFiles) {
                            // Pass caption to upload function
                            const uploaded = await uploadMediaToWordPress(item.file, siteUrl, basicAuth, item.caption);
                            allImagesIds.push(uploaded.id);
                            updateProgress(++filesUploaded, totalFiles, `Uploading gallery images (${filesUploaded}/${totalFiles})...`);
                        }
                    }
                    
                    // NEW: Upload from featuredImageFile variable
                    let featuredImageId = null;
                    if (featuredImageFile) {
                        const uploaded = await uploadMediaToWordPress(featuredImageFile, siteUrl, basicAuth);
                        featuredImageId = uploaded.id;
                        updateProgress(++filesUploaded, totalFiles, `Uploading featured image (${filesUploaded}/${totalFiles})...`);
                    }
                    
                    // (Optional Files logic remains the same, as it doesn't use state variables)
                    const files = [];
                    if (filesContainer) {
                        filesContainer.querySelectorAll('.flex').forEach(row => {
                            const titleInput = row.querySelector('input[type="text"]');
                            const fileInput = row.querySelector('.file-input-dynamic');
                            if (titleInput && fileInput && fileInput.files.length > 0) {
                                files.push({
                                    title: titleInput.value || fileInput.files[0].name, 
                                    file: fileInput.files[0]
                                });
                            }
                        });
                    }
                    
                    const fileData = [];
                    for (const fileItem of files) {
                        const uploaded = await uploadMediaToWordPress(fileItem.file, siteUrl, basicAuth);
                        fileData.push({
                            title: fileItem.title,
                            id: uploaded.id,
                            url: uploaded.source_url
                        });
                        updateProgress(++filesUploaded, totalFiles, `Uploading files (${filesUploaded}/${totalFiles})...`);
                    }
                    
                    const linksContainer = document.getElementById('portfolio-links-container');
                    const links = [];
                    if (linksContainer) {
                        linksContainer.querySelectorAll('.flex').forEach(row => {
                            const titleInput = row.querySelector('input[type="text"]');
                            const urlInput = row.querySelector('input[type="url"]');
                            if (titleInput && urlInput && urlInput.value) {
                                const url = ensureHttps(urlInput.value);
                                links.push({
                                    title: titleInput.value || url,
                                    url: url
                                });
                            }
                        });
                    }
                    
                    data = {
                        template: templateType,
                        title: title,
                        description: description,
                        tags: tags,
                        allImages: allImagesIds,
                        featuredImage: featuredImageId,
                        files: fileData,
                        links: links
                    };
                    
                    if (templateType === 'exhibition') {
                        data.gallery = document.getElementById('portfolio-gallery').value;
                        data.startDate = document.getElementById('portfolio-start-date').value;
                        data.endDate = document.getElementById('portfolio-end-date').value;
                    }
                }
                
                if (totalFiles > 0 && filesUploaded === totalFiles) {
                    updateProgress(totalFiles, totalFiles, 'All files uploaded. Creating post...');
                } else if (totalFiles === 0) {
                     updateProgress(0, 0, 'Creating post...');
                }
                
                // === API Call ===
                const apiUrl = `${siteUrl}/wp-json/content-collector/v1/create-post`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': basicAuth
                    },
                    body: JSON.stringify(data)
                });

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    console.error('Response status:', response.status);
                    console.error('Response URL:', response.url);
                    
                    let errorMsg = `Server returned an error page. Status: ${response.status}.`;
                    if (text.includes('404')) {
                        errorMsg += ' The API endpoint was not found. Please ensure the plugin is active and the REST API is enabled.';
                    } else if (text.length < 500) {
                        errorMsg += ' Response: ' + text.substring(0, 200);
                    }
                    throw new Error(errorMsg);
                }

                if (!response.ok) {
                    throw result; // Throw WP error object
                }

                // === Success! ===
                loadingProgressContainer.style.display = 'none';
                loadingProgressText.style.display = 'none';
                messageError.style.display = 'none';
                messageSuccess.style.display = 'block';
                successText.textContent = `Post "${result.post_title}" (ID: ${result.post_id}) has been created as a draft.`;
                editLink.href = result.edit_link;
                viewLink.href = result.view_link;

                event.target.reset(); 
                
                eraseStorage(autoSaveKey);

                // NEW: Clear state variables and render empty previews
                featuredImageFile = null;
                videoFile = null;
                galleryFiles = [];
                renderFeaturedImagePreview();
                renderVideoPreview();
                renderGalleryPreview();
                
                document.getElementById('portfolio-files-container').innerHTML = '';
                document.getElementById('portfolio-links-container').innerHTML = '';
                document.querySelectorAll('p[id$="-title-status"]').forEach(p => p.innerHTML = '');
                document.getElementById('portfolio-tags-status').innerHTML = '';
                document.querySelector('input[name="video-source"][value="url"]').click();


            } catch (error) {
                // === Error! ===
                console.error('Error creating post:', error);
                let errorMessage = 'An unknown error occurred.';
                
                if (error && error.message) {
                    errorMessage = error.message;
                } else if (error instanceof Error) {
                    errorMessage = error.message;
                }
                
                if (error.code === 'rest_unauthorized' || errorMessage.includes('Unauthorized') || errorMessage.includes('session has expired')) {
                    errorMessage = "Your credentials seem to be invalid or expired. Please log out and log back in.";
                    showLoginScreen(errorMessage);
                } else {
                     showError(errorMessage); 
                }
            } finally {
                if(submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = submitButton.dataset.defaultText || 'Submit';
                }
            }
        }
        
        // --- Event Listeners for Generate Buttons ---
        mediaLinkForm.addEventListener('submit', (e) => handleFormSubmit(e, 'media-link'));
        mediaVideoForm.addEventListener('submit', (e) => handleFormSubmit(e, 'media-video'));
        portfolioForm.addEventListener('submit', (e) => {
            const templateType = templateSelect.value; 
            handleFormSubmit(e, templateType);
        });

    </script>
</body>
</html>